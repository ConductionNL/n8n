apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: n8n
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://community-charts.github.io/helm-charts
    chart: n8n
    targetRevision: "1.16.10"  # pinned for stability
    helm:
      releaseName: n8n
      # Keep this in sync with values.yaml (not referenced directly by Argo CD)
      values: |
        gracefulShutdownTimeout: 120
        strategy:
          type: Recreate
        service:
          type: ClusterIP
          port: 5678
        ingress:
          enabled: true
          className: nginx
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
          hosts:
            - host: n8n.commonground.nu
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts:
                - n8n.commonground.nu
              secretName: n8n-tls
        db:
          type: postgresdb
          postgresdb:
            ssl:
              enabled: true
              rejectUnauthorized: false
            connectionTimeout: 60000
        main:
          persistence:
            enabled: true
            size: 10Gi
            storageClass: default
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /healthz/readiness
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6
          extraEnvVars:
            N8N_HOST: n8n.commonground.nu
            N8N_PROTOCOL: https
            WEBHOOK_URL: https://n8n.commonground.nu/
            DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED: "false"
            NODE_TLS_REJECT_UNAUTHORIZED: "0"
            DB_POSTGRESDB_CONNECTION_TIMEOUT: "60000"
        existingEncryptionKeySecret: n8n-encryption
        externalPostgresql:
          host: n8n-postgres.n8n-db.svc
          port: 5432
          database: n8n
          username: bjhu
          existingSecret: n8n-db
  destination:
    server: https://kubernetes.default.svc
    namespace: n8n
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
